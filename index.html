<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>note stats dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg-primary: #0a0a0f;
  --bg-secondary: #12121a;
  --bg-card: #16161f;
  --bg-card-hover: #1c1c28;
  --border: #2a2a3a;
  --border-subtle: #1e1e2e;
  --text-primary: #e8e8f0;
  --text-secondary: #8888a0;
  --text-muted: #555570;
  --accent-cyan: #00d4ff;
  --accent-cyan-dim: #00d4ff33;
  --accent-pink: #ff3d8e;
  --accent-pink-dim: #ff3d8e33;
  --accent-amber: #ffb020;
  --accent-amber-dim: #ffb02033;
  --accent-green: #00e676;
  --accent-green-dim: #00e67633;
  --accent-purple: #a855f7;
  --accent-purple-dim: #a855f733;
  --glow-cyan: 0 0 20px #00d4ff22;
  --glow-pink: 0 0 20px #ff3d8e22;
  --font-mono: 'JetBrains Mono', monospace;
  --font-sans: 'Noto Sans JP', sans-serif;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  background: var(--bg-primary);
  color: var(--text-primary);
  font-family: var(--font-sans);
  min-height: 100vh;
  overflow-x: hidden;
}

/* Subtle grid background */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background-image:
    linear-gradient(var(--border-subtle) 1px, transparent 1px),
    linear-gradient(90deg, var(--border-subtle) 1px, transparent 1px);
  background-size: 60px 60px;
  opacity: 0.3;
  pointer-events: none;
  z-index: 0;
}

.app { position: relative; z-index: 1; }

/* Header */
.header {
  padding: 32px 40px 24px;
  border-bottom: 1px solid var(--border);
  background: linear-gradient(180deg, #0e0e16 0%, var(--bg-primary) 100%);
}

.header-top {
  display: flex;
  align-items: baseline;
  gap: 16px;
  margin-bottom: 8px;
}

.header h1 {
  font-family: var(--font-mono);
  font-size: 24px;
  font-weight: 600;
  color: var(--accent-cyan);
  letter-spacing: -0.5px;
}

.header h1 span {
  color: var(--text-muted);
  font-weight: 300;
}

.header-meta {
  font-family: var(--font-mono);
  font-size: 14px;
  color: var(--text-muted);
}

.header-meta .live {
  color: var(--accent-green);
  animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.4; }
}

/* KPI Strip */
.kpi-strip {
  display: flex;
  gap: 1px;
  background: var(--border);
  margin: 0;
  border-bottom: 1px solid var(--border);
}

.kpi-item {
  flex: 1;
  background: var(--bg-secondary);
  padding: 20px 24px;
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.kpi-label {
  font-family: var(--font-mono);
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 1.5px;
  color: var(--text-muted);
}

.kpi-value {
  font-family: var(--font-mono);
  font-size: 34px;
  font-weight: 700;
  color: var(--text-primary);
  line-height: 1;
}

.kpi-value.cyan { color: var(--accent-cyan); }
.kpi-value.pink { color: var(--accent-pink); }
.kpi-value.amber { color: var(--accent-amber); }
.kpi-value.green { color: var(--accent-green); }
.kpi-value.purple { color: var(--accent-purple); }

.kpi-sub {
  font-family: var(--font-mono);
  font-size: 13px;
  color: var(--text-muted);
}

.kpi-sub .up { color: var(--accent-green); }
.kpi-sub .down { color: var(--accent-pink); }
.kpi-sub .flat { color: var(--text-muted); }

.kpi-sub .arrow {
  font-size: 16px;
  margin-right: 2px;
}

/* Detail KPI sub strip */
.kpi-strip-sub {
  background: var(--bg-secondary);
  border-bottom: 1px solid var(--border);
}

.kpi-item-sub {
  flex: 1;
  background: var(--bg-secondary);
  padding: 10px 24px;
  display: flex;
  align-items: center;
  gap: 10px;
  font-family: var(--font-mono);
}

.kpi-sub-label {
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--text-muted);
}

.kpi-sub-value {
  font-size: 16px;
  font-weight: 600;
  color: var(--text-secondary);
}

.kpi-sub-diff {
  font-size: 12px;
  color: var(--text-muted);
}

.kpi-sub-diff .up { color: var(--accent-green); }
.kpi-sub-diff .down { color: var(--accent-pink); }

/* Main Grid */
.grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1px;
  background: var(--border);
  border-bottom: 1px solid var(--border);
}

.panel {
  background: var(--bg-primary);
  padding: 24px;
  min-height: 400px;
  display: flex;
  flex-direction: column;
}

.panel-full {
  grid-column: 1 / -1;
}

.panel-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 20px;
  flex-shrink: 0;
}

.panel-title {
  font-family: var(--font-mono);
  font-size: 14px;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 1.5px;
  color: var(--text-secondary);
}

.panel-title::before {
  content: '‚ñ∏ ';
  color: var(--accent-cyan);
}

.panel-badge {
  font-family: var(--font-mono);
  font-size: 12px;
  padding: 3px 8px;
  border-radius: 3px;
  background: var(--accent-cyan-dim);
  color: var(--accent-cyan);
  border: 1px solid #00d4ff44;
}

/* Charts container */
.chart-container {
  flex: 1;
  position: relative;
  overflow: hidden;
}

/* Bar chart (horizontal) */
.bar-chart {
  display: flex;
  flex-direction: column;
  gap: 3px;
  overflow-y: auto;
  max-height: 360px;
  padding-right: 8px;
}

.bar-chart::-webkit-scrollbar { width: 4px; }
.bar-chart::-webkit-scrollbar-track { background: var(--bg-secondary); }
.bar-chart::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

.bar-row {
  display: grid;
  grid-template-columns: 1fr 60px;
  align-items: center;
  gap: 12px;
  padding: 4px 0;
  font-size: 12px;
  cursor: default;
  transition: background 0.15s;
  padding: 4px 8px;
  border-radius: 4px;
}

.bar-row:hover {
  background: var(--bg-card);
}

.bar-label-wrap {
  display: flex;
  flex-direction: column;
  gap: 3px;
  min-width: 0;
}

.bar-title {
  font-size: 13px;
  color: var(--text-secondary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.bar-track {
  width: 100%;
  height: 6px;
  background: var(--bg-card);
  border-radius: 3px;
  overflow: hidden;
}

.bar-fill {
  height: 100%;
  border-radius: 3px;
  transition: width 0.8s cubic-bezier(0.22, 1, 0.36, 1);
  position: relative;
}

.bar-fill.cyan { background: linear-gradient(90deg, var(--accent-cyan), #00a8cc); }
.bar-fill.pink { background: linear-gradient(90deg, var(--accent-pink), #cc2266); }
.bar-fill.amber { background: linear-gradient(90deg, var(--accent-amber), #cc8800); }

.bar-value {
  font-family: var(--font-mono);
  font-size: 14px;
  font-weight: 600;
  text-align: right;
  color: var(--accent-cyan);
}

/* Scatter plot (canvas) */
canvas {
  width: 100% !important;
  height: 100% !important;
}

/* Decay chart */
.decay-legend {
  display: flex;
  gap: 16px;
  flex-wrap: wrap;
  margin-top: 12px;
}

.decay-legend-item {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 13px;
  color: var(--text-secondary);
  font-family: var(--font-mono);
}

.decay-legend-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
}

/* Summary line chart */
.summary-legend {
  display: flex;
  gap: 20px;
  margin-top: 8px;
}

.summary-legend-item {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 11px;
  color: var(--text-secondary);
  font-family: var(--font-mono);
  cursor: pointer;
  transition: opacity 0.2s;
}

.summary-legend-item:hover { opacity: 0.8; }

.summary-legend-line {
  width: 16px;
  height: 3px;
  border-radius: 2px;
}

/* Tooltip */
.tooltip {
  position: fixed;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 10px 14px;
  font-family: var(--font-mono);
  font-size: 13px;
  color: var(--text-primary);
  pointer-events: none;
  z-index: 100;
  box-shadow: 0 8px 32px rgba(0,0,0,0.5);
  max-width: 300px;
  display: none;
}

.tooltip-title {
  color: var(--accent-cyan);
  margin-bottom: 4px;
  font-weight: 600;
}

.tooltip-row {
  color: var(--text-secondary);
  line-height: 1.6;
}

/* Footer */
.footer {
  padding: 16px 40px;
  text-align: center;
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--text-muted);
}

/* Responsive */
@media (max-width: 900px) {
  .grid { grid-template-columns: 1fr; }
  .kpi-strip { flex-wrap: wrap; }
  .kpi-item { min-width: 50%; }
  .header { padding: 20px; }
  .panel { padding: 16px; }
  .commentary-strip { padding: 12px 20px; flex-wrap: wrap; gap: 8px; }
}

/* Animations */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}

.panel { animation: fadeIn 0.4s ease-out both; }
.panel:nth-child(2) { animation-delay: 0.1s; }
.panel:nth-child(3) { animation-delay: 0.2s; }
.panel:nth-child(4) { animation-delay: 0.3s; }

/* Commentary strip */
.commentary-strip {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 14px 40px;
  background: var(--bg-secondary);
  border-bottom: 1px solid var(--border);
  font-family: var(--font-mono);
}

.commentary-label {
  font-size: 12px;
  color: var(--text-muted);
  white-space: nowrap;
  letter-spacing: 0.5px;
}

.commentary-text {
  font-size: 14px;
  color: var(--text-primary);
  flex: 1;
}

.commentary-copy {
  font-family: var(--font-mono);
  font-size: 12px;
  color: var(--accent-cyan);
  background: none;
  border: 1px solid var(--accent-cyan-dim);
  padding: 4px 14px;
  border-radius: 4px;
  cursor: pointer;
  white-space: nowrap;
  transition: all 0.2s;
}

.commentary-copy:hover {
  background: var(--accent-cyan-dim);
}

/* No data state */
.no-data {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 100%;
  color: var(--text-muted);
  font-family: var(--font-mono);
  font-size: 13px;
}
</style>
</head>
<body>

<div class="app">
  <!-- Header -->
  <header class="header">
    <div class="header-top">
      <h1>note-stats <span>dashboard</span></h1>
    </div>
    <div class="header-meta">
      <span class="live">‚óè</span> data updated: <span id="lastUpdate">--</span>
      &nbsp;|&nbsp; articles: <span id="articleCount">--</span>
      &nbsp;|&nbsp; tracking since: <span id="trackingSince">--</span>
    </div>
  </header>

  <!-- KPI Strip -->
  <div class="kpi-strip">
    <div class="kpi-item">
      <div class="kpi-label">„É™„Éº„ÉÅÂäõ</div>
      <div class="kpi-value cyan" id="kpiReach">--</div>
      <div class="kpi-sub" id="kpiReachSub">PV √∑ Ë®ò‰∫ãÊï∞</div>
    </div>
    <div class="kpi-item">
      <div class="kpi-label">„Ç¢„ÇØ„Ç∑„Éß„É≥Âäõ</div>
      <div class="kpi-value pink" id="kpiAction">--</div>
      <div class="kpi-sub" id="kpiActionSub">„Çπ„Ç≠ √∑ Ë®ò‰∫ãÊï∞</div>
    </div>
    <div class="kpi-item">
      <div class="kpi-label">„Çπ„Ç≠Áéá (Œ∑)</div>
      <div class="kpi-value amber" id="kpiEta">--</div>
      <div class="kpi-sub" id="kpiEtaSub">„Çπ„Ç≠ √∑ PV</div>
    </div>
    <div class="kpi-item">
      <div class="kpi-label">Followers</div>
      <div class="kpi-value green" id="kpiFollowers">--</div>
      <div class="kpi-sub" id="kpiFollowersSub"></div>
    </div>
    <div class="kpi-item">
      <div class="kpi-label">Articles</div>
      <div class="kpi-value purple" id="kpiArticles">--</div>
      <div class="kpi-sub" id="kpiArticlesSub"></div>
    </div>
  </div>

  <!-- Detail KPI (Total PV / Likes / Comments) -->
  <div class="kpi-strip kpi-strip-sub">
    <div class="kpi-item-sub">
      <span class="kpi-sub-label">Total PV</span>
      <span class="kpi-sub-value" id="kpiPV">--</span>
      <span class="kpi-sub-diff" id="kpiPVsub"></span>
    </div>
    <div class="kpi-item-sub">
      <span class="kpi-sub-label">Total Likes</span>
      <span class="kpi-sub-value" id="kpiLikes">--</span>
      <span class="kpi-sub-diff" id="kpiLikesSub"></span>
    </div>
    <div class="kpi-item-sub">
      <span class="kpi-sub-label">Total Comments</span>
      <span class="kpi-sub-value" id="kpiComments">--</span>
      <span class="kpi-sub-diff" id="kpiCommentsSub"></span>
    </div>
  </div>

  <!-- Áä∂ÊÖã„É°„É¢ÔºàËá™ÂãïÁîüÊàêÔºâ -->
  <div class="commentary-strip" id="commentaryStrip" style="display:none;">
    <div class="commentary-label">üìù ‰ªäÊó•„ÅÆÁä∂ÊÖã„É°„É¢ÔºàËá™ÂãïÁîüÊàêÔºâ</div>
    <div class="commentary-text" id="commentaryText"></div>
    <button class="commentary-copy" id="commentaryCopy" onclick="copyCommentary()">Copy</button>
  </div>

  <!-- Charts Grid -->
  <div class="grid">
    <!-- 1. Like Rate Ranking -->
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">„Çπ„Ç≠Áéá„É©„É≥„Ç≠„É≥„Ç∞</div>
        <div class="panel-badge" id="rankingBadge">TOP 20</div>
      </div>
      <div class="chart-container">
        <div class="bar-chart" id="rankingChart">
          <div class="no-data">CSV„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Çì„Åß„Åè„Å†„Åï„ÅÑ</div>
        </div>
      </div>
    </div>

    <!-- 2. PV vs Likes Scatter -->
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">PV √ó „Çπ„Ç≠ Êï£Â∏ÉÂõ≥</div>
        <div class="panel-badge">Áõ∏Èñ¢ÂàÜÊûê</div>
      </div>
      <div class="chart-container">
        <canvas id="scatterCanvas"></canvas>
      </div>
    </div>

    <!-- 3. Recent Articles Œ∑ Trend (full width) -->
    <div class="panel panel-full">
      <div class="panel-header">
        <div class="panel-title">Áõ¥Ëøë2ÈÄ±Èñì „Çπ„Ç≠ÁéáÊé®Áßª</div>
        <div class="panel-badge" id="etaTrendBadge">--</div>
      </div>
      <div class="chart-container">
        <canvas id="etaTrendCanvas"></canvas>
      </div>
      <div class="decay-legend" id="etaTrendLegend"></div>
    </div>
  </div>

  <footer class="footer">
    note-stats-dashboard v0.1 ‚Äî data stays in your browser
  </footer>
</div>

<!-- Tooltip -->
<div class="tooltip" id="tooltip">
  <div class="tooltip-title" id="tooltipTitle"></div>
  <div class="tooltip-row" id="tooltipBody"></div>
</div>

<script>
// ===== State =====
let articlesData = [];
let dailySummary = [];
let latestSnapshot = [];
let summaryData = []; // from daily_summary.csv

// ===== CSV Parser =====
function parseCSV(text) {
  const lines = text.trim().replace(/\r/g, '').split('\n');
  if (lines.length < 2) return [];
  const headers = lines[0].split(',');
  return lines.slice(1).map(line => {
    const vals = [];
    let current = '';
    let inQuotes = false;
    for (const ch of line) {
      if (ch === '"') { inQuotes = !inQuotes; }
      else if (ch === ',' && !inQuotes) { vals.push(current); current = ''; }
      else { current += ch; }
    }
    vals.push(current);
    const obj = {};
    headers.forEach((h, i) => obj[h.trim()] = (vals[i] || '').trim());
    return obj;
  });
}

// ===== Data Processing =====
function processData(rows) {
  articlesData = rows.map(r => ({
    date: r.date,
    note_id: r.note_id,
    key: r.key,
    title: r.title || '',
    published_at: r.published_at || '',
    age_days: parseInt(r.age_days) || 0,
    read_count: parseInt(r.read_count) || 0,
    like_count: parseInt(r.like_count) || 0,
    comment_count: parseInt(r.comment_count) || 0,
  }));

  // Get unique dates sorted
  const dates = [...new Set(articlesData.map(a => a.date))].sort();

  // Latest snapshot (most recent date)
  const latestDate = dates[dates.length - 1];
  latestSnapshot = articlesData.filter(a => a.date === latestDate);

  // Daily summary from each date
  dailySummary = dates.map(d => {
    const dayArticles = articlesData.filter(a => a.date === d);
    const totalPV = dayArticles.reduce((s, a) => s + a.read_count, 0);
    const totalLikes = dayArticles.reduce((s, a) => s + a.like_count, 0);
    const totalComments = dayArticles.reduce((s, a) => s + a.comment_count, 0);
    return { date: d, totalPV, totalLikes, totalComments, articleCount: dayArticles.length };
  });

  updateKPI();
  updateCommentary();
  renderRanking();
  renderScatter();
  renderEtaTrend();
  updateHeader(dates);
}

// ===== KPI =====
function updateKPI() {
  // Use summaryData if available, otherwise fall back to articles-derived summary
  const src = summaryData.length > 0 ? summaryData : dailySummary;
  const latest = src[src.length - 1];
  const prev = src.length > 1 ? src[src.length - 2] : null;

  if (!latest) return;

  const articleCount = latest.articleCount || latestSnapshot.length;
  const totalPV = latest.totalPV;
  const totalLikes = latest.totalLikes;
  const totalComments = latest.totalComments;
  const followers = latest.followerCount || 0;

  // 3KPI (KITAcore style)
  const reach = articleCount > 0 ? (totalPV / articleCount) : 0;
  const action = articleCount > 0 ? (totalLikes / articleCount) : 0;
  const eta = totalPV > 0 ? (totalLikes / totalPV * 100) : 0;

  document.getElementById('kpiReach').textContent = reach.toFixed(1);
  document.getElementById('kpiAction').textContent = action.toFixed(1);
  document.getElementById('kpiEta').textContent = eta.toFixed(1) + '%';
  document.getElementById('kpiFollowers').textContent = followers.toLocaleString();
  document.getElementById('kpiArticles').textContent = articleCount;

  // Detail row
  document.getElementById('kpiPV').textContent = totalPV.toLocaleString();
  document.getElementById('kpiLikes').textContent = totalLikes.toLocaleString();
  document.getElementById('kpiComments').textContent = totalComments.toLocaleString();

  if (prev) {
    const prevArticleCount = prev.articleCount || articleCount;
    const prevPV = prev.totalPV;
    const prevLikes = prev.totalLikes;
    const prevComments = prev.totalComments;
    const prevFollowers = prev.followerCount || 0;

    const prevReach = prevArticleCount > 0 ? (prevPV / prevArticleCount) : 0;
    const prevAction = prevArticleCount > 0 ? (prevLikes / prevArticleCount) : 0;
    const prevEta = prevPV > 0 ? (prevLikes / prevPV * 100) : 0;

    document.getElementById('kpiReachSub').innerHTML = arrowLabel(reach - prevReach, '/article');
    document.getElementById('kpiActionSub').innerHTML = arrowLabel(action - prevAction, '/article');
    document.getElementById('kpiEtaSub').innerHTML = arrowLabel(eta - prevEta, 'pts', true);
    document.getElementById('kpiFollowersSub').innerHTML = arrowLabel(followers - prevFollowers, '');
    document.getElementById('kpiArticlesSub').innerHTML = arrowLabel(articleCount - prevArticleCount, ' new');

    // Detail row diffs
    document.getElementById('kpiPVsub').innerHTML = diffBadge(totalPV - prevPV);
    document.getElementById('kpiLikesSub').innerHTML = diffBadge(totalLikes - prevLikes);
    document.getElementById('kpiCommentsSub').innerHTML = diffBadge(totalComments - prevComments);
  }
}

function arrowLabel(diff, unit, isFloat) {
  let arrow, cls;
  if (diff > 0.001) { arrow = '‚Üë'; cls = 'up'; }
  else if (diff < -0.001) { arrow = '‚Üì'; cls = 'down'; }
  else { arrow = '‚Üí'; cls = 'flat'; }
  const val = isFloat ? Math.abs(diff).toFixed(2) : Math.abs(Math.round(diff));
  return `<span class="${cls}"><span class="arrow">${arrow}</span>${val}${unit}</span>`;
}

function diffBadge(diff) {
  const sign = diff >= 0 ? '+' : '';
  const cls = diff >= 0 ? 'up' : 'down';
  return `<span class="${cls}">${sign}${diff}</span>`;
}

// ===== Commentary Auto-generation =====
function updateCommentary() {
  const src = summaryData.length > 0 ? summaryData : dailySummary;
  if (src.length < 2) {
    document.getElementById('commentaryStrip').style.display = 'none';
    return;
  }

  const latest = src[src.length - 1];
  const prev = src[src.length - 2];

  const articleCount = latest.articleCount || latestSnapshot.length;
  const prevArticleCount = prev.articleCount || articleCount;

  const reach = articleCount > 0 ? (latest.totalPV / articleCount) : 0;
  const action = articleCount > 0 ? (latest.totalLikes / articleCount) : 0;
  const eta = latest.totalPV > 0 ? (latest.totalLikes / latest.totalPV * 100) : 0;

  const prevReach = prevArticleCount > 0 ? (prev.totalPV / prevArticleCount) : 0;
  const prevAction = prevArticleCount > 0 ? (prev.totalLikes / prevArticleCount) : 0;
  const prevEta = prev.totalPV > 0 ? (prev.totalLikes / prev.totalPV * 100) : 0;

  const dir = (diff) => diff > 0.001 ? '‚Üë' : (diff < -0.001 ? '‚Üì' : '‚Üí');

  const rDir = dir(reach - prevReach);
  const aDir = dir(action - prevAction);
  const eDir = dir(eta - prevEta);
  const key = rDir + aDir + eDir;

  const templates = {
    '‚Üë‚Üë‚Üë': 'ÂÖ®ÊåáÊ®ô‰∏äÊòá„ÄÇÂ•ΩË™øÊó•„ÄÇ',
    '‚Üë‚Üë‚Üí': '„É™„Éº„ÉÅ„Éª„Ç¢„ÇØ„Ç∑„Éß„É≥ÂÖ±„Å´‰∏äÊòá„ÄÇ„Çπ„Ç≠Áéá„ÅØÂÆâÂÆö„ÄÇ',
    '‚Üë‚Üë‚Üì': 'Èú≤Âá∫„ÇÇ„Ç¢„ÇØ„Ç∑„Éß„É≥„ÇÇÂ¢óÂä†„ÄÇ„Åü„Å†„Åó„Çπ„Ç≠Áéá„ÅØ‰Ωé‰∏ã„ÄÅÊñ∞Ë¶èÊµÅÂÖ•„ÅåÂ§ö„ÅÑÂèØËÉΩÊÄß„ÄÇ',
    '‚Üë‚Üí‚Üë': '„É™„Éº„ÉÅÊã°Â§ßÔºã„Çπ„Ç≠Áéá‰∏äÊòá„ÄÇË™≠ËÄÖ„ÅÆË≥™„ÅåËâØ„ÅÑÊµÅÂÖ•„ÄÇ',
    '‚Üë‚Üí‚Üí': '„É™„Éº„ÉÅÂæÆÂ¢ó„ÄÇÂÖ®‰ΩìÁöÑ„Å´„ÅØÂÆâÂÆöÊé®Áßª„ÄÇ',
    '‚Üë‚Üí‚Üì': '„É™„Éº„ÉÅ„ÅØ‰º∏„Å≥„Åü„Åå„Çπ„Ç≠Áéá‰Ωé‰∏ã„ÄÇ„Çø„Ç§„Éà„É´Âãù„Å°„ÅÆÂèØËÉΩÊÄß„ÄÇ',
    '‚Üë‚Üì‚Üë': 'Èú≤Âá∫„ÅØÂ¢ó„Åà„Åü„Åå„Ç¢„ÇØ„Ç∑„Éß„É≥Ê∏õ„ÄÇ„Çπ„Ç≠Áéá„ÅØÊîπÂñÑ„ÄÅÂõ∫ÂÆöÂ±§„ÅåÂèçÂøú„Åã„ÄÇ',
    '‚Üë‚Üì‚Üí': 'Èú≤Âá∫Â¢ó„ÄÅ„Ç¢„ÇØ„Ç∑„Éß„É≥Ê∏õ„ÄÇÊñ∞Ë¶è„ÅÆÂèçÂøú„ÅåËñÑ„ÅÑÂèØËÉΩÊÄß„ÄÇ',
    '‚Üë‚Üì‚Üì': 'Èú≤Âá∫„ÅØÂ¢ó„Åà„Åü„ÅåÂà∫„Åï„Å£„Å¶„Å™„ÅÑ„ÄÇ„Çø„Ç§„Éà„É´Âãù„Å°„ÅÆÂèØËÉΩÊÄß„ÄÇ',
    '‚Üí‚Üë‚Üë': '„É™„Éº„ÉÅÊ®™„Å∞„ÅÑ„Åß„Ç¢„ÇØ„Ç∑„Éß„É≥„Éª„Çπ„Ç≠Áéá‰∏äÊòá„ÄÇÂÜÖÂÆπ„ÅÆË≥™„ÅåÈ´ò„ÅÑ„ÄÇ',
    '‚Üí‚Üë‚Üí': '„Ç¢„ÇØ„Ç∑„Éß„É≥ÂæÆÂ¢ó„ÄÇÂÆâÂÆö„Åó„ÅüÈÅãÂñ∂Êó•„ÄÇ',
    '‚Üí‚Üë‚Üì': '„Ç¢„ÇØ„Ç∑„Éß„É≥Â¢ó„Å†„Åå„Çπ„Ç≠Áéá‰Ωé‰∏ã„ÄÇPVÂ¢ó„Åå„Ç¢„ÇØ„Ç∑„Éß„É≥Â¢ó„Çí‰∏äÂõû„Å£„Å¶„ÅÑ„Çã„ÄÇ',
    '‚Üí‚Üí‚Üë': '„Çπ„Ç≠Áéá„Å†„ÅëÂæÆÂ¢ó„ÄÇË™≠ËÄÖ„ÅÆË≥™„Åå„Åò„Çè„ÇäÂêë‰∏ä„ÄÇ',
    '‚Üí‚Üí‚Üí': 'ÂÆâÂÆöÊé®Áßª„ÄÇÁèæÁä∂Á∂≠ÊåÅ„ÄÇ',
    '‚Üí‚Üí‚Üì': '„Çπ„Ç≠Áéá„Å†„ÅëÂæÆÊ∏õ„ÄÇÂ§ß„Åç„Å™Â§âÂåñ„ÅØ„Å™„Åó„ÄÇ',
    '‚Üí‚Üì‚Üë': '„Ç¢„ÇØ„Ç∑„Éß„É≥Ê∏õ„Å†„Åå„Çπ„Ç≠Áéá„ÅØ‰∏äÊòá„ÄÇPVÊ∏õ„Åß„Çπ„Ç≠Áéá„ÅåÁõ∏ÂØæÁöÑ„Å´‰∏äÊòá„Åã„ÄÇ',
    '‚Üí‚Üì‚Üí': '„Ç¢„ÇØ„Ç∑„Éß„É≥ÂæÆÊ∏õ„ÄÇÁµåÈÅéË¶≥ÂØü„ÄÇ',
    '‚Üí‚Üì‚Üì': '„Ç¢„ÇØ„Ç∑„Éß„É≥„Éª„Çπ„Ç≠ÁéáÂÖ±„Å´‰Ωé‰∏ã„ÄÇ„ÉÜ„Éº„Éû„ÅãÊäïÁ®ø„Çø„Ç§„Éü„É≥„Ç∞„ÇíÁ¢∫Ë™ç„ÄÇ',
    '‚Üì‚Üë‚Üë': '„É™„Éº„ÉÅÊ∏õ„Åß„ÇÇ„Ç¢„ÇØ„Ç∑„Éß„É≥„Éª„Çπ„Ç≠Áéá„ÅØ‰∏äÊòá„ÄÇÂõ∫ÂÆöË™≠ËÄÖ„ÅÆÂèçÂøú„ÅåÊøÉ„ÅÑÊó•„ÄÇ',
    '‚Üì‚Üë‚Üí': '„É™„Éº„ÉÅÊ∏õ„Å†„Åå„Ç¢„ÇØ„Ç∑„Éß„É≥Â¢ó„ÄÇÂ∞ëÊï∞„Å†„ÅåÂà∫„Åï„Å£„Å¶„ÅÑ„Çã„ÄÇ',
    '‚Üì‚Üë‚Üì': '„É™„Éº„ÉÅÊ∏õ„ÄÅ„Ç¢„ÇØ„Ç∑„Éß„É≥Â¢ó„ÄÅ„Çπ„Ç≠Áéá‰Ωé‰∏ã„ÄÇÂ§âÂãïÂ§ß„Åç„ÇÅ„ÄÅÁøåÊó•„ÇÇË¶≥ÂØü„ÄÇ',
    '‚Üì‚Üí‚Üë': 'ÈñëÊï£Êó•„Å†„ÅåË≥™„ÅØÈ´ò„ÅÑ„ÄÇÂõ∫ÂÆöË™≠ËÄÖ„ÅåÂèçÂøú„ÄÇ',
    '‚Üì‚Üí‚Üí': '„É™„Éº„ÉÅÂæÆÊ∏õ„ÄÇÂ§ß„Åç„Å™Â§âÂåñ„Å™„Åó„ÄÇ',
    '‚Üì‚Üí‚Üì': '„É™„Éº„ÉÅ„Éª„Çπ„Ç≠ÁéáÂÖ±„Å´ÂæÆÊ∏õ„ÄÇÁ∑©„ÇÑ„Åã„Å™‰∏ãÈôçÂÇæÂêë„ÄÇ',
    '‚Üì‚Üì‚Üë': '„É™„Éº„ÉÅ„Éª„Ç¢„ÇØ„Ç∑„Éß„É≥ÂÖ±„Å´Ê∏õÂ∞ë„Å†„Åå„Çπ„Ç≠Áéá„ÅØ‰∏äÊòá„ÄÇPVÊ∏õ„Å´„Çà„ÇãÁõ∏ÂØæÂäπÊûú„ÅÆÂèØËÉΩÊÄß„ÄÇ',
    '‚Üì‚Üì‚Üí': '„É™„Éº„ÉÅ„Éª„Ç¢„ÇØ„Ç∑„Éß„É≥Ê∏õ„ÄÇÊäïÁ®ø„ÅÆ„Å™„ÅÑÊó• or „ÉÜ„Éº„Éû„ÅåÂêà„Çè„Å™„Åã„Å£„ÅüÂèØËÉΩÊÄß„ÄÇ',
    '‚Üì‚Üì‚Üì': 'ÂÖ®ÊåáÊ®ô‰∏ãÈôç„ÄÇ‰∏ÄÊôÇÁöÑ„Å™ËêΩ„Å°Ëæº„Åø„Åã„ÄÅ„ÉÜ„Éº„Éû„Éª„Çø„Ç§„Éü„É≥„Ç∞„ÅÆË¶ãÁõ¥„Åó„Çí„ÄÇ',
  };

  const comment = templates[key] || 'Âà§ÂÆö‰∏çËÉΩ„ÄÇ„Éá„Éº„Çø„ÇíÁ¢∫Ë™ç„ÄÇ';
  const dateStr = latest.date || '';
  const displayComment = `${dateStr} | „É™„Éº„ÉÅ${rDir} „Ç¢„ÇØ„Ç∑„Éß„É≥${aDir} „Çπ„Ç≠Áéá${eDir} | ${comment}`;
  const copyComment = `„É™„Éº„ÉÅ${rDir} „Ç¢„ÇØ„Ç∑„Éß„É≥${aDir} „Çπ„Ç≠Áéá${eDir} | ${comment}`;

  document.getElementById('commentaryText').textContent = displayComment;
  document.getElementById('commentaryText').dataset.copyText = copyComment;
  document.getElementById('commentaryStrip').style.display = 'flex';
}

function copyCommentary() {
  const text = document.getElementById('commentaryText').dataset.copyText;
  navigator.clipboard.writeText(text).then(() => {
    const btn = document.getElementById('commentaryCopy');
    btn.textContent = 'Copied!';
    setTimeout(() => { btn.textContent = 'Copy'; }, 1500);
  });
}

function updateHeader(dates) {
  document.getElementById('lastUpdate').textContent = dates[dates.length - 1];
  document.getElementById('articleCount').textContent = latestSnapshot.length;
  document.getElementById('trackingSince').textContent = dates[0];
}

// ===== 1. Ranking =====
function renderRanking() {
  const container = document.getElementById('rankingChart');
  const sorted = [...latestSnapshot]
    .map(a => ({ ...a, eta: a.read_count > 0 ? (a.like_count / a.read_count * 100) : 0 }))
    .sort((a, b) => b.eta - a.eta);

  const top = sorted.slice(0, 20);
  const maxEta = Math.max(...top.map(a => a.eta), 1);

  container.innerHTML = top.map((a, i) => {
    const pct = (a.eta / maxEta * 100).toFixed(1);
    const colorClass = i < 3 ? 'cyan' : i < 10 ? 'amber' : 'pink';
    const shortTitle = a.title.replace(/^„Äê.*?„Äë/, '').replace(/\|.*$/, '').trim();
    return `
      <div class="bar-row" onmouseenter="showTooltip(event, '${escHtml(a.title)}', 'PV: ${a.read_count} / „Çπ„Ç≠: ${a.like_count} / Œ∑: ${a.eta.toFixed(1)}%')" onmouseleave="hideTooltip()">
        <div class="bar-label-wrap">
          <div class="bar-title">${shortTitle || a.key}</div>
          <div class="bar-track"><div class="bar-fill ${colorClass}" style="width:${pct}%"></div></div>
        </div>
        <div class="bar-value">${a.eta.toFixed(1)}%</div>
      </div>`;
  }).join('');

  document.getElementById('rankingBadge').textContent = `TOP ${top.length}`;
}

// ===== 2. Scatter =====
function renderScatter() {
  const canvas = document.getElementById('scatterCanvas');
  const ctx = canvas.getContext('2d');
  const rect = canvas.parentElement.getBoundingClientRect();
  const dpr = window.devicePixelRatio || 1;
  canvas.width = rect.width * dpr;
  canvas.height = rect.height * dpr;
  ctx.scale(dpr, dpr);
  const W = rect.width, H = rect.height;

  ctx.clearRect(0, 0, W, H);

  if (latestSnapshot.length === 0) return;

  const pad = { top: 20, right: 20, bottom: 40, left: 50 };
  const cw = W - pad.left - pad.right;
  const ch = H - pad.top - pad.bottom;

  const maxPV = Math.max(...latestSnapshot.map(a => a.read_count), 1);
  const maxLike = Math.max(...latestSnapshot.map(a => a.like_count), 1);

  // Grid lines
  ctx.strokeStyle = '#1e1e2e';
  ctx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    const y = pad.top + (ch / 4) * i;
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(W - pad.right, y); ctx.stroke();
    const x = pad.left + (cw / 4) * i;
    ctx.beginPath(); ctx.moveTo(x, pad.top); ctx.lineTo(x, H - pad.bottom); ctx.stroke();
  }

  // Average eta line (diagonal)
  const avgEta = latestSnapshot.reduce((s, a) => s + a.like_count, 0) /
                 Math.max(latestSnapshot.reduce((s, a) => s + a.read_count, 0), 1);
  ctx.strokeStyle = '#ffb02044';
  ctx.lineWidth = 1;
  ctx.setLineDash([4, 4]);
  ctx.beginPath();
  ctx.moveTo(pad.left, pad.top + ch);
  const diagX = pad.left + cw;
  const diagY = pad.top + ch - (maxPV * avgEta / maxLike) * ch;
  ctx.lineTo(diagX, Math.max(diagY, pad.top));
  ctx.stroke();
  ctx.setLineDash([]);

  // Avg eta label
  ctx.fillStyle = '#ffb02088';
  ctx.font = '12px JetBrains Mono';
  ctx.fillText(`avg Œ∑=${(avgEta * 100).toFixed(1)}%`, diagX - 80, Math.max(diagY, pad.top) - 4);

  // Points
  const points = latestSnapshot.map(a => {
    const x = pad.left + (a.read_count / maxPV) * cw;
    const y = pad.top + ch - (a.like_count / maxLike) * ch;
    const eta = a.read_count > 0 ? a.like_count / a.read_count : 0;
    return { x, y, eta, ...a };
  });

  points.forEach(p => {
    const isHigh = p.eta > avgEta * 1.5;
    const isLow = p.eta < avgEta * 0.5 && p.read_count > maxPV * 0.2;
    let color = '#00d4ff';
    let radius = 4;
    if (isHigh) { color = '#00e676'; radius = 6; }
    if (isLow) { color = '#ff3d8e'; radius = 6; }

    ctx.beginPath();
    ctx.arc(p.x, p.y, radius, 0, Math.PI * 2);
    ctx.fillStyle = color + '88';
    ctx.fill();
    ctx.strokeStyle = color;
    ctx.lineWidth = 1.5;
    ctx.stroke();

    if (isHigh || isLow) {
      ctx.fillStyle = color;
      ctx.font = '11px JetBrains Mono';
      const label = p.title.replace(/^„Äê.*?„Äë/, '').replace(/\|.*$/, '').substring(0, 15);
      ctx.fillText(label, p.x + 8, p.y - 4);
    }
  });

  // Axes labels
  ctx.fillStyle = '#555570';
  ctx.font = '12px JetBrains Mono';
  ctx.textAlign = 'center';
  ctx.fillText('PV ‚Üí', W / 2, H - 8);
  ctx.save();
  ctx.translate(12, H / 2);
  ctx.rotate(-Math.PI / 2);
  ctx.fillText('„Çπ„Ç≠ ‚Üí', 0, 0);
  ctx.restore();
  ctx.textAlign = 'start';

  // Axis numbers
  ctx.fillStyle = '#555570';
  ctx.font = '11px JetBrains Mono';
  ctx.textAlign = 'right';
  for (let i = 0; i <= 4; i++) {
    const val = Math.round(maxLike / 4 * (4 - i));
    ctx.fillText(val, pad.left - 6, pad.top + (ch / 4) * i + 4);
  }
  ctx.textAlign = 'center';
  for (let i = 0; i <= 4; i++) {
    const val = Math.round(maxPV / 4 * i);
    ctx.fillText(val, pad.left + (cw / 4) * i, H - pad.bottom + 16);
  }

  // Canvas tooltip
  canvas.onmousemove = (e) => {
    const r = canvas.getBoundingClientRect();
    const mx = e.clientX - r.left, my = e.clientY - r.top;
    let found = null;
    for (const p of points) {
      if (Math.hypot(p.x - mx, p.y - my) < 10) { found = p; break; }
    }
    if (found) {
      showTooltip(e, found.title, `PV: ${found.read_count} / „Çπ„Ç≠: ${found.like_count} / Œ∑: ${(found.eta * 100).toFixed(1)}%`);
    } else {
      hideTooltip();
    }
  };
  canvas.onmouseleave = hideTooltip;
}

// ===== 3. Recent Articles Œ∑ Dot Plot =====
function renderEtaTrend() {
  const canvas = document.getElementById('etaTrendCanvas');
  const ctx = canvas.getContext('2d');
  const rect = canvas.parentElement.getBoundingClientRect();
  const dpr = window.devicePixelRatio || 1;
  canvas.width = rect.width * dpr;
  canvas.height = rect.height * dpr;
  ctx.scale(dpr, dpr);
  const W = rect.width, H = rect.height;
  ctx.clearRect(0, 0, W, H);

  const dates = [...new Set(articlesData.map(a => a.date))].sort();
  const latestDate = dates[dates.length - 1];

  // Build 14-day range ending at latestDate
  const endDate = new Date(latestDate + 'T00:00:00');
  const daySlots = [];
  for (let i = 13; i >= 0; i--) {
    const d = new Date(endDate);
    d.setDate(d.getDate() - i);
    const iso = d.toISOString().substring(0, 10);
    daySlots.push(iso);
  }

  // Find articles published within this 14-day range, using latest snapshot eta
  const recentArticles = latestSnapshot
    .filter(a => {
      if (!a.published_at) return false;
      const pubDay = a.published_at.substring(0, 10);
      return pubDay >= daySlots[0] && pubDay <= daySlots[daySlots.length - 1];
    })
    .map(a => ({
      ...a,
      pubDay: a.published_at.substring(0, 10),
      eta: a.read_count > 0 ? (a.like_count / a.read_count * 100) : 0,
    }));

  if (recentArticles.length === 0) {
    ctx.fillStyle = '#555570';
    ctx.font = '15px JetBrains Mono';
    ctx.textAlign = 'center';
    ctx.fillText('Áõ¥Ëøë2ÈÄ±Èñì„Å´ÊäïÁ®ø„Åï„Çå„ÅüË®ò‰∫ã„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', W / 2, H / 2);
    document.getElementById('etaTrendLegend').innerHTML = '';
    document.getElementById('etaTrendBadge').textContent = '0 articles';
    return;
  }

  const pad = { top: 28, right: 40, bottom: 58, left: 55 };
  const cw = W - pad.left - pad.right;
  const ch = H - pad.top - pad.bottom;

  // Y scale
  const maxEta = Math.ceil(Math.max(...recentArticles.map(a => a.eta), 10) / 5) * 5;

  // Grid
  const gridSteps = 5;
  for (let i = 0; i <= gridSteps; i++) {
    const y = pad.top + (ch / gridSteps) * i;
    ctx.strokeStyle = '#1e1e2e';
    ctx.lineWidth = 1;
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(W - pad.right, y); ctx.stroke();

    const val = (maxEta / gridSteps * (gridSteps - i)).toFixed(0);
    ctx.fillStyle = '#555570';
    ctx.font = '11px JetBrains Mono';
    ctx.textAlign = 'right';
    ctx.fillText(val + '%', pad.left - 8, y + 3);
  }

  // Average Œ∑ line
  const avgEta = latestSnapshot.reduce((s, a) => s + a.like_count, 0) /
                 Math.max(latestSnapshot.reduce((s, a) => s + a.read_count, 0), 1) * 100;
  const avgY = pad.top + ch - (avgEta / maxEta) * ch;
  ctx.strokeStyle = '#ffb02044';
  ctx.lineWidth = 1;
  ctx.setLineDash([6, 4]);
  ctx.beginPath();
  ctx.moveTo(pad.left, avgY);
  ctx.lineTo(W - pad.right, avgY);
  ctx.stroke();
  ctx.setLineDash([]);
  ctx.fillStyle = '#ffb02077';
  ctx.font = '11px JetBrains Mono';
  ctx.textAlign = 'left';
  ctx.fillText(`ÂÖ®‰ΩìÂπ≥Âùá Œ∑=${avgEta.toFixed(1)}%`, pad.left + 4, avgY - 6);

  // X axis - 14 day slots
  const slotWidth = cw / daySlots.length;

  // Vertical slot separators (subtle)
  daySlots.forEach((d, i) => {
    const x = pad.left + slotWidth * i + slotWidth / 2;
    ctx.strokeStyle = '#1a1a28';
    ctx.lineWidth = 1;
    ctx.beginPath(); ctx.moveTo(x, pad.top); ctx.lineTo(x, pad.top + ch); ctx.stroke();
  });

  // X labels
  const dowLabels = ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'];
  ctx.font = '11px JetBrains Mono';
  ctx.textAlign = 'center';
  daySlots.forEach((d, i) => {
    const x = pad.left + slotWidth * i + slotWidth / 2;
    const label = d.substring(5); // MM-DD
    const dayOfWeek = new Date(d + 'T00:00:00').getDay();
    const dowLabel = `(${dowLabels[dayOfWeek]})`;
    if (dayOfWeek === 0 || dayOfWeek === 6) {
      ctx.fillStyle = '#666680';
    } else {
      ctx.fillStyle = '#444460';
    }
    ctx.fillText(label, x, H - pad.bottom + 16);
    ctx.fillText(dowLabel, x, H - pad.bottom + 30);
  });

  // Average Œ∑ for color thresholds
  const avgEtaForColor = latestSnapshot.reduce((s, a) => s + a.like_count, 0) /
                 Math.max(latestSnapshot.reduce((s, a) => s + a.read_count, 0), 1) * 100;

  // Plot dots
  const plotPoints = [];
  // Group articles by pubDay to handle same-day offsets
  const byDay = {};
  recentArticles.forEach(a => {
    if (!byDay[a.pubDay]) byDay[a.pubDay] = [];
    byDay[a.pubDay].push(a);
  });

  Object.entries(byDay).forEach(([day, articles]) => {
    const slotIdx = daySlots.indexOf(day);
    if (slotIdx === -1) return;
    const cx = pad.left + slotWidth * slotIdx + slotWidth / 2;

    articles.forEach((a, j) => {
      const cy = pad.top + ch - (a.eta / maxEta) * ch;
      // Offset horizontally if multiple on same day
      const offset = articles.length > 1 ? (j - (articles.length - 1) / 2) * 14 : 0;
      const px = cx + offset;

      // 3-color based on eta vs average (matching scatter plot)
      let color;
      if (a.eta > avgEtaForColor * 1.5) {
        color = '#00e676'; // green - high performer
      } else if (a.eta < avgEtaForColor * 0.5) {
        color = '#ff3d8e'; // pink - underperformer
      } else {
        color = '#00d4ff'; // cyan - average
      }

      // Glow
      ctx.beginPath();
      ctx.arc(px, cy, 10, 0, Math.PI * 2);
      ctx.fillStyle = color + '15';
      ctx.fill();

      // Dot
      ctx.beginPath();
      ctx.arc(px, cy, 6, 0, Math.PI * 2);
      ctx.fillStyle = color + 'cc';
      ctx.fill();
      ctx.strokeStyle = color;
      ctx.lineWidth = 2;
      ctx.stroke();

      // Œ∑ label above dot
      ctx.fillStyle = color;
      ctx.font = '12px JetBrains Mono';
      ctx.textAlign = 'center';
      ctx.fillText(a.eta.toFixed(1) + '%', px, cy - 12);

      plotPoints.push({ x: px, y: cy, color, ...a });
    });
  });

  document.getElementById('etaTrendBadge').textContent = `${recentArticles.length} articles`;

  // Legend - 3 color explanation
  const legend = document.getElementById('etaTrendLegend');
  legend.innerHTML = `
    <div class="decay-legend-item"><div class="decay-legend-dot" style="background:#00e676"></div>Œ∑È´òÔºàÂπ≥Âùá√ó1.5‰ª•‰∏äÔºâ</div>
    <div class="decay-legend-item"><div class="decay-legend-dot" style="background:#00d4ff"></div>Œ∑Âπ≥Âùá‰ªòËøë</div>
    <div class="decay-legend-item"><div class="decay-legend-dot" style="background:#ff3d8e"></div>Œ∑‰ΩéÔºàÂπ≥Âùá√ó0.5‰ª•‰∏ãÔºâ</div>
    <div class="decay-legend-item" style="margin-left:12px;color:#ffb02077">--- ÂÖ®‰ΩìÂπ≥Âùá Œ∑=${avgEtaForColor.toFixed(1)}%</div>
  `;

  // Tooltip
  canvas.onmousemove = (e) => {
    const r = canvas.getBoundingClientRect();
    const mx = e.clientX - r.left, my = e.clientY - r.top;
    let found = null;
    for (const p of plotPoints) {
      if (Math.hypot(p.x - mx, p.y - my) < 12) { found = p; break; }
    }
    if (found) {
      showTooltip(e, found.title, `ÊäïÁ®ø: ${found.pubDay} / PV: ${found.read_count} / „Çπ„Ç≠: ${found.like_count} / Œ∑: ${found.eta.toFixed(1)}%`);
    } else {
      hideTooltip();
    }
  };
  canvas.onmouseleave = hideTooltip;
}

// ===== Tooltip =====
function showTooltip(e, title, body) {
  const tt = document.getElementById('tooltip');
  document.getElementById('tooltipTitle').textContent = title;
  document.getElementById('tooltipBody').textContent = body;
  tt.style.display = 'block';
  tt.style.left = (e.clientX + 14) + 'px';
  tt.style.top = (e.clientY - 10) + 'px';
}

function hideTooltip() {
  document.getElementById('tooltip').style.display = 'none';
}

function escHtml(s) {
  return s.replace(/'/g, "\\'").replace(/"/g, '&quot;');
}

// ===== Load from repo (GitHub Pages) =====
async function loadFromRepo() {
  try {
    // Load articles.csv
    const res = await fetch('./data/articles.csv');
    if (res.ok) {
      const text = await res.text();
      const rows = parseCSV(text);
      if (rows.length > 0) {
        // Load daily_summary.csv
        try {
          const sumRes = await fetch('./data/daily_summary.csv');
          if (sumRes.ok) {
            const sumText = await sumRes.text();
            const sumRows = parseCSV(sumText);
            summaryData = sumRows.map(r => ({
              date: r.date,
              articleCount: parseInt(r.article_count) || 0,
              totalPV: parseInt(r.total_pv) || 0,
              totalLikes: parseInt(r.total_like) || 0,
              totalComments: parseInt(r.total_comment) || 0,
              followerCount: parseInt(r.follower_count) || 0,
            })).sort((a, b) => a.date.localeCompare(b.date));
          }
        } catch (e) {}

        processData(rows);
        return true;
      }
    }
  } catch (e) {}
  return false;
}

// ===== Init =====
window.addEventListener('resize', () => {
  if (latestSnapshot.length > 0) {
    renderScatter();
    renderEtaTrend();
  }
});

// Try to load from repo on init
loadFromRepo();
</script>
</body>
</html>
